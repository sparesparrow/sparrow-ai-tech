<div id="elevenlabs-widget">
    <button id="play-button">Listen to this page</button>
    <audio id="audio-player" style="display:none;"></audio>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const playButton = document.getElementById('play-button');
    const audioPlayer = document.getElementById('audio-player');
    const textToSpeak = document.querySelector('article') ? document.querySelector('article').innerText : document.body.innerText;
    const voiceId = window.elevenlabsVoiceId || '21m00Tcm4TlvDq8ikWAM'; // Default voice ID

    playButton.addEventListener('click', getAudio);

    async function getAudio() {
        playButton.disabled = true;
        playButton.classList.add('loading');
        playButton.innerText = 'Loading...';

        try {
            const response = await fetch('/api/text-to-speech', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: textToSpeak,
                    voice_id: voiceId
                }),
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayer.src = audioUrl;
            audioPlayer.style.display = 'block';
            audioPlayer.play();
            playButton.classList.remove('error');
        } catch (error) {
            console.error('Error fetching audio:', error);
            playButton.innerText = 'Error - Try again';
            playButton.classList.add('error');
        } finally {
            setTimeout(() => {
                playButton.disabled = false;
                playButton.classList.remove('loading');
                playButton.innerText = 'Listen to this page';
            }, 2000);
        }
    }
});
</script>
