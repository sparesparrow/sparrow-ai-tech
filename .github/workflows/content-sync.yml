
name: Sync External Repository Documentation

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-documentation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          
      - name: üìÅ Create content directory
        run: mkdir -p src/content/projects
        
      - name: üîÑ Sync documentation from repositories
        run: |
          # Repository list - easily configurable
          REPOS=(
            "sparesparrow/human-action"
            "sparesparrow/mcp-prompts" 
            "sparesparrow/mcp-prompts-rs"
            "sparesparrow/mcp-project-orchestrator"
            "sparesparrow/mcp-router"
          )
          
          for REPO_PATH in "${REPOS[@]}"; do
            REPO_NAME=$(echo $REPO_PATH | cut -d"/" -f2)
            CLONE_URL="https://github.com/${REPO_PATH}.git"
            TEMP_DIR="temp_${REPO_NAME}"
            
            echo "üì• Syncing documentation for ${REPO_NAME}..."
            
            # Clone with error handling
            if git clone --depth 1 $CLONE_URL $TEMP_DIR; then
              SOURCE_DOC="${TEMP_DIR}/README.md"
              DEST_DOC="src/content/projects/${REPO_NAME}.md"
              
              if [ -f "$SOURCE_DOC" ]; then
                # Create Astro frontmatter
                cat > "$DEST_DOC" << DOCEOF
---
title: "${REPO_NAME}"
description: "Documentation for the ${REPO_NAME} project"
repository: "${REPO_PATH}"
lastUpdated: "$(date --iso-8601)"
tags: ["mcp", "automation", "project"]
---

DOCEOF
                
                # Append README content
                cat "$SOURCE_DOC" >> "$DEST_DOC"
                echo "‚úÖ Successfully synced ${REPO_NAME}"
              else
                echo "‚ö†Ô∏è README.md not found in ${REPO_NAME}"
              fi
            else
              echo "‚ùå Failed to clone ${REPO_NAME}"
            fi
            
            # Cleanup
            rm -rf $TEMP_DIR
          done
          
      - name: üíæ Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: sync external repository documentation [automated]"
          file_pattern: "src/content/projects/*.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: üì• Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: true

      - name: ‚úÖ Astro check
        run: pnpm run check

